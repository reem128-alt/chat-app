<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .chat-container {
        width: 90%;
        max-width: 800px;
        height: 80vh;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .chat-header h1 {
        font-size: 24px;
        margin-bottom: 5px;
      }

      .chat-header p {
        opacity: 0.9;
      }

      .login-form {
        padding: 40px;
        text-align: center;
      }

      .login-form h2 {
        margin-bottom: 30px;
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
      }

      .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
      }

      .message.own {
        flex-direction: row-reverse;
      }

      .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
      }

      .message.own .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .message:not(.own) .message-content {
        background: white;
        color: #333;
        border: 1px solid #e1e5e9;
      }

      .message-info {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 5px;
      }

      .chat-input {
        padding: 20px;
        background: white;
        border-top: 1px solid #e1e5e9;
        display: flex;
        gap: 10px;
      }

      .chat-input input {
        flex: 1;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 25px;
        font-size: 16px;
        outline: none;
      }

      .chat-input input:focus {
        border-color: #667eea;
      }

      .online-users {
        padding: 10px 20px;
        background: #f8f9fa;
        border-top: 1px solid #e1e5e9;
        font-size: 14px;
        color: #666;
      }

      .typing-indicator {
        padding: 10px 20px;
        font-style: italic;
        color: #666;
        font-size: 14px;
      }

      .hidden {
        display: none;
      }

      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        text-align: center;
      }

      .status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <h1>ðŸ’¬ Chat App</h1>
        <p>Real-time messaging with MongoDB & Redis</p>
      </div>

      <!-- Login Form -->
      <div id="loginForm" class="login-form">
        <h2>Join the Chat</h2>
        <div class="form-group">
          <label for="username">Username:</label>
          <input
            type="text"
            id="username"
            placeholder="Enter your username"
            required
          />
        </div>
        <div class="form-group">
          <label for="email">Email:</label>
          <input
            type="email"
            id="email"
            placeholder="Enter your email"
            required
          />
        </div>
        <button class="btn" onclick="joinChat()">Join Chat</button>
      </div>

      <!-- Chat Interface -->
      <div id="chatInterface" class="hidden">
        <div id="status" class="status disconnected">Connecting...</div>
        <div id="onlineUsers" class="online-users">Online: 0 users</div>
        <div id="chatMessages" class="chat-messages"></div>
        <div id="typingIndicator" class="typing-indicator hidden"></div>
        <div class="chat-input">
          <input
            type="text"
            id="messageInput"
            placeholder="Type your message..."
            onkeypress="handleKeyPress(event)"
          />
          <button class="btn" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // Generate MongoDB-compatible ObjectId
      function generateObjectId() {
        const timestamp = Math.floor(Date.now() / 1000).toString(16);
        const randomBytes = Array.from({length: 16}, () => Math.floor(Math.random() * 16).toString(16)).join('');
        return (timestamp + randomBytes).substring(0, 24);
      }

      let socket;
      let currentUser = null;
      let typingTimer;

      function joinChat() {
        const username = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();

        if (!username || !email) {
          alert("Please enter both username and email");
          return;
        }

        // Create user object (in a real app, this would be handled by authentication)
        currentUser = {
          id: generateObjectId(), // Temporary ID
          username: username,
          email: email,
        };

        // Connect to socket
        socket = io();

        socket.on("connect", () => {
          updateStatus("Connected", "connected");
          document.getElementById("loginForm").classList.add("hidden");
          document.getElementById("chatInterface").classList.remove("hidden");

          // Join the default chat room
          socket.emit("join", {
            userId: currentUser.id,
            username: currentUser.username,
            chatRoomId: generateObjectId(), // Generate proper room ID
          });
        });

        socket.on("disconnect", () => {
          updateStatus("Disconnected", "disconnected");
        });

        socket.on("recent_messages", (messages) => {
          messages.forEach((message) => {
            displayMessage(message);
          });
        });

        socket.on("new_message", (message) => {
          displayMessage(message);
        });

        socket.on("user_joined", (data) => {
          displaySystemMessage(`${data.username} joined the chat`);
        });

        socket.on("user_left", (data) => {
          displaySystemMessage(`${data.username} left the chat`);
        });

        socket.on("user_typing", (data) => {
          showTypingIndicator(data);
        });

        socket.on("error", (data) => {
          alert("Error: " + data.message);
        });
      }

      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const content = messageInput.value.trim();

        if (!content || !socket) return;

        socket.emit("send_message", {
          content: content,
          chatRoomId: generateObjectId(), // Generate proper room ID
          senderId: currentUser.id,
        });

        messageInput.value = "";
        stopTyping();
      }

      function displayMessage(message) {
        const messagesContainer = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${
          message.sender.id === currentUser.id ? "own" : ""
        }`;

        messageDiv.innerHTML = `
                <div class="message-content">
                    <div>${message.content}</div>
                    <div class="message-info">
                        ${message.sender.username} â€¢ ${new Date(
          message.timestamp
        ).toLocaleTimeString()}
                    </div>
                </div>
            `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function displaySystemMessage(message) {
        const messagesContainer = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";
        messageDiv.innerHTML = `
                <div class="message-content" style="background: #e3f2fd; color: #1976d2; text-align: center; font-style: italic;">
                    ${message}
                </div>
            `;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function showTypingIndicator(data) {
        const indicator = document.getElementById("typingIndicator");
        if (data.isTyping) {
          indicator.textContent = `${data.username} is typing...`;
          indicator.classList.remove("hidden");
        } else {
          indicator.classList.add("hidden");
        }
      }

      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        } else {
          startTyping();
        }
      }

      function startTyping() {
        if (!socket) return;

        socket.emit("typing_start", { chatRoomId: generateObjectId() }); // Generate proper room ID

        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          stopTyping();
        }, 1000);
      }

      function stopTyping() {
        if (!socket) return;

        socket.emit("typing_stop", { chatRoomId: generateObjectId() }); // Generate proper room ID
        clearTimeout(typingTimer);
      }

      function updateStatus(message, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
      }
    </script>
  </body>
</html>
